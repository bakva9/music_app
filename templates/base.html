{% load static %}<!DOCTYPE html>
<html lang="ja" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>{% block title %}残音{% endblock %}</title>
    <!-- PWA -->
    <link rel="manifest" href="{% static 'manifest.json' %}">
    <meta name="theme-color" content="#c73058">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="{% static 'icons/icon-192.png' %}">
    <!-- OGP -->
    <meta property="og:site_name" content="残音">
    <meta property="og:title" content="{% block og_title %}残音 - 音楽学習パートナー{% endblock %}">
    <meta property="og:description" content="{% block og_description %}練習記録・作曲管理・ライブ記録・音楽理論を一元管理する音楽学習アプリ{% endblock %}">
    <meta property="og:image" content="{% block og_image %}{{ request.scheme }}://{{ request.get_host }}{% static 'icons/ogp.png' %}{% endblock %}">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#fef2f5', 100: '#fde4eb', 200: '#f8c4d0', 300: '#f2a0b4', 400: '#e06888', 500: '#c73058', 600: '#a82044', 700: '#8b1a38', 800: '#70152e', 900: '#4a0e1e', 950: '#2a0810' },
                        cosmic: { 50: '#fef2f5', 100: '#fde4eb', 200: '#f8c4d0', 300: '#f2a0b4', 400: '#e06888', 500: '#c73058', 600: '#a82044', 700: '#8b1a38', 800: '#70152e', 900: '#4a0e1e', 950: '#2a0810' },
                        nebula: { 50: '#fff8f0', 100: '#ffedd5', 200: '#fed7aa', 300: '#fdba74', 400: '#fb923c', 500: '#f07020', 600: '#e05a10', 700: '#c2410c', 800: '#9a3412', 900: '#7c2d12' },
                        stardust: '#ffd700',
                        aurora: '#00ff88',
                        comet: '#ff6b6b',
                        supernova: '#ff9f43',
                    },
                    fontFamily: {
                        sans: ['Inter', 'Zen Maru Gothic', 'system-ui', 'sans-serif'],
                        display: ['Zen Maru Gothic', 'Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    boxShadow: {
                        'glow-sm': '0 0 10px rgba(199,48,88,0.15)',
                        'glow': '0 0 20px rgba(199,48,88,0.2)',
                        'glow-lg': '0 0 40px rgba(199,48,88,0.25)',
                        'glow-teal': '0 0 20px rgba(240,112,32,0.2)',
                        'glow-orange': '0 0 20px rgba(255,159,67,0.2)',
                        'glow-green': '0 0 20px rgba(0,255,136,0.2)',
                    },
                }
            }
        }
    </script>
    <style>
        /* === Starfield Background === */
        .starfield {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }
        .starfield .stars-sm,
        .starfield .stars-md,
        .starfield .stars-lg {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 200%;
            border-radius: 50%;
        }
        .starfield .stars-sm {
            width: 1px; height: 1px;
            box-shadow:
                24px 89px #fff, 150px 320px #fff, 290px 50px #fff, 410px 180px #fff, 530px 400px #fff,
                680px 120px #fff, 790px 350px #fff, 910px 60px #fff, 1050px 290px #fff, 1180px 440px #fff,
                70px 510px #fff, 200px 680px #fff, 340px 570px #fff, 480px 730px #fff, 610px 600px #fff,
                750px 760px #fff, 890px 520px #fff, 1020px 700px #fff, 1150px 580px #fff, 1280px 670px #fff,
                45px 890px #fff, 170px 1020px #fff, 310px 860px #fff, 460px 980px #fff, 590px 1100px #fff,
                720px 910px #fff, 860px 1060px #fff, 1000px 870px #fff, 1130px 1010px #fff, 1270px 930px #fff,
                100px 1200px #fff, 240px 1350px #fff, 380px 1180px #fff, 520px 1320px #fff, 660px 1250px #fff,
                800px 1400px #fff, 940px 1160px #fff, 1080px 1300px #fff, 1220px 1200px #fff, 1350px 1380px #fff,
                30px 1500px #fff, 180px 1620px #fff, 320px 1540px #fff, 470px 1680px #fff, 620px 1570px #fff,
                760px 1650px #fff, 900px 1500px #fff, 1040px 1600px #fff, 1190px 1540px #fff, 1320px 1700px #fff,
                55px 1850px #fff, 210px 1950px #fff, 350px 1800px #fff, 500px 1920px #fff, 640px 1870px #fff,
                780px 2000px #fff, 920px 1810px #fff, 1060px 1930px #fff, 1200px 1860px #fff, 1340px 1980px #fff;
            animation: starfield-drift 180s linear infinite;
            opacity: 0.6;
        }
        .starfield .stars-md {
            width: 2px; height: 2px;
            box-shadow:
                80px 150px rgba(255,255,255,0.9), 260px 400px rgba(255,255,255,0.8), 440px 100px rgba(255,255,255,0.9),
                620px 300px rgba(255,255,255,0.8), 800px 500px rgba(255,255,255,0.9), 980px 200px rgba(255,255,255,0.8),
                1160px 450px rgba(255,255,255,0.9), 130px 600px rgba(255,255,255,0.8), 350px 750px rgba(255,255,255,0.9),
                570px 650px rgba(255,255,255,0.8), 760px 850px rgba(255,255,255,0.9), 950px 720px rgba(255,255,255,0.8),
                1120px 800px rgba(255,255,255,0.9), 60px 1000px rgba(255,255,255,0.8), 280px 1150px rgba(255,255,255,0.9),
                500px 1050px rgba(255,255,255,0.8), 710px 1200px rgba(255,255,255,0.9), 930px 1100px rgba(255,255,255,0.8),
                1100px 1300px rgba(255,255,255,0.9), 200px 1400px rgba(255,255,255,0.8);
            animation: starfield-drift 240s linear infinite;
            opacity: 0.5;
        }
        .starfield .stars-lg {
            width: 3px; height: 3px;
            box-shadow:
                180px 250px rgba(224,104,136,0.8), 540px 100px rgba(240,112,32,0.7), 900px 380px rgba(255,215,0,0.6),
                1200px 150px rgba(224,104,136,0.7), 360px 500px rgba(240,112,32,0.8), 720px 680px rgba(255,215,0,0.7),
                1050px 550px rgba(224,104,136,0.6), 100px 800px rgba(240,112,32,0.7), 450px 950px rgba(255,215,0,0.8),
                800px 1050px rgba(224,104,136,0.7), 1150px 900px rgba(240,112,32,0.6), 250px 1200px rgba(255,215,0,0.7);
            animation: twinkle 4s ease-in-out infinite alternate, starfield-drift 300s linear infinite;
        }

        /* === Nebula Gradient === */
        .cosmic-bg {
            background:
                radial-gradient(ellipse at 15% 60%, rgba(199,48,88,0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 85% 25%, rgba(240,112,32,0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 80%, rgba(255,107,107,0.04) 0%, transparent 40%),
                linear-gradient(180deg, #2a0810 0%, #4a0e1e 30%, #1a0a12 70%, #150810 100%);
            background-attachment: fixed;
        }
        .starfield { opacity: 1; }

        /* === Keyframe Animations === */
        @keyframes starfield-drift {
            from { transform: translateY(0); }
            to { transform: translateY(-50%); }
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 15px rgba(199,48,88,0.1); }
            50% { box-shadow: 0 0 30px rgba(199,48,88,0.3); }
        }
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes scale-in {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes shooting-star {
            0% { transform: translateX(0) translateY(0) rotate(45deg); opacity: 0; width: 0; }
            5% { opacity: 1; width: 80px; }
            70% { opacity: 1; }
            100% { transform: translateX(500px) translateY(500px) rotate(45deg); opacity: 0; width: 0; }
        }

        /* === Utility Animation Classes === */
        .animate-float { animation: float 3s ease-in-out infinite; }
        .animate-pulse-glow { animation: pulse-glow 3s ease-in-out infinite; }
        .animate-fade-in-up { animation: fade-in-up 0.5s ease-out forwards; }
        .animate-scale-in { animation: scale-in 0.4s ease-out forwards; }

        /* === HTMX Swap Animations === */
        .htmx-added { animation: fade-in-up 0.3s ease-out; }
        .htmx-settling { animation: fade-in-up 0.3s ease-out; }
        .htmx-swapping { opacity: 0; transition: opacity 0.2s ease-out; }

        /* === HTMX Loading Indicator === */
        .htmx-indicator {
            display: none;
        }
        .htmx-request .htmx-indicator,
        .htmx-request.htmx-indicator {
            display: inline-flex;
        }
        @keyframes spinner-rotate {
            to { transform: rotate(360deg); }
        }
        .loading-spinner {
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid rgba(199,48,88,0.2);
            border-top-color: #c73058;
            border-radius: 50%;
            animation: spinner-rotate 0.6s linear infinite;
        }

        /* === Global HTMX Request Progress Bar === */
        .htmx-progress {
            position: fixed;
            top: 0; left: 0;
            height: 2px;
            background: linear-gradient(90deg, #c73058, #f07020, #ffd700);
            z-index: 9999;
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease-out;
            pointer-events: none;
            width: 100%;
        }
        .htmx-progress.active {
            transform: scaleX(0.85);
            transition: transform 8s cubic-bezier(0.1, 0.5, 0.1, 1);
        }
        .htmx-progress.done {
            transform: scaleX(1);
            transition: transform 0.15s ease-out;
        }
        .htmx-progress.fade {
            opacity: 0;
            transition: opacity 0.4s ease-out;
        }

        /* === Toast Notification === */
        @keyframes toast-in {
            from { opacity: 0; transform: translateY(-12px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes toast-out {
            from { opacity: 1; transform: translateY(0) scale(1); }
            to { opacity: 0; transform: translateY(-12px) scale(0.95); }
        }
        .toast-enter { animation: toast-in 0.3s cubic-bezier(0.22, 1, 0.36, 1) forwards; }
        .toast-exit { animation: toast-out 0.25s ease-in forwards; }

        /* === Form Inputs (Django rendered) === */
        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="number"],
        input[type="url"],
        input[type="tel"],
        input[type="date"],
        input[type="datetime-local"],
        input[type="search"],
        textarea,
        select {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border-radius: 0.75rem;
            font-size: 0.875rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            outline: none;
            background-color: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: #f3f4f6;
        }
        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="password"]:focus,
        input[type="number"]:focus,
        input[type="url"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus,
        input[type="datetime-local"]:focus,
        input[type="search"]:focus,
        textarea:focus,
        select:focus {
            border-color: rgba(199,48,88,0.5);
            box-shadow: 0 0 0 3px rgba(199,48,88,0.15);
        }
        input::placeholder,
        textarea::placeholder {
            color: rgba(255,255,255,0.25);
        }
        /* Checkbox / Radio - keep inline */
        input[type="checkbox"],
        input[type="radio"] {
            width: auto;
            accent-color: #c73058;
        }

        /* === Text Glow === */
        .text-glow { text-shadow: 0 0 20px rgba(199,48,88,0.3), 0 0 40px rgba(199,48,88,0.1); }
        .text-glow-teal { text-shadow: 0 0 20px rgba(240,112,32,0.3); }

        /* === Brand Title Treatment === */
        .brand-title {
            background: linear-gradient(135deg, #e06888 0%, #fb923c 40%, #ffd700 100%);
            background-size: 200% 200%;
            background-position: 0% 50%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            transition: background-position 0.6s ease;
        }
        .group:hover .brand-title {
            background-position: 100% 50%;
        }
        .brand-title-glow {
            filter: drop-shadow(0 0 8px rgba(240,112,32,0.2)) drop-shadow(0 0 20px rgba(199,48,88,0.12));
        }

        /* === Glassmorphism Fallback === */
        @supports not (backdrop-filter: blur(12px)) {
            .glass-card { background: rgba(74, 14, 30, 0.85) !important; }
        }

        /* === PWA Chat Widget Positioning === */
        .chat-toggle-btn {
            bottom: calc(1.5rem + env(safe-area-inset-bottom, 0px));
            right: calc(1.5rem + env(safe-area-inset-right, 0px));
        }
        .chat-panel {
            bottom: calc(6rem + env(safe-area-inset-bottom, 0px));
            right: 0.75rem;
            left: 0.75rem;
            max-height: calc(100dvh - 7rem - env(safe-area-inset-top, 0px) - env(safe-area-inset-bottom, 0px));
        }
        @media (min-width: 640px) {
            .chat-panel {
                left: auto;
                right: calc(1.5rem + env(safe-area-inset-right, 0px));
                width: 24rem;
            }
        }

        /* === Accessibility: Reduced Motion === */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            .starfield { display: none; }
        }

        /* === Smooth Page Transitions === */
        @keyframes page-enter {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        main { animation: page-enter 0.35s cubic-bezier(0.22, 1, 0.36, 1); }
    </style>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    {% block extra_head %}{% endblock %}
</head>
<body class="cosmic-bg text-gray-900 dark:text-gray-100 min-h-screen flex flex-col relative">
    <!-- HTMX Progress Bar -->
    <div id="htmx-progress" class="htmx-progress"></div>

    <!-- Starfield Background -->
    <div class="starfield" aria-hidden="true">
        <div class="stars-sm"></div>
        <div class="stars-md"></div>
        <div class="stars-lg"></div>
    </div>

    <div class="relative z-10 flex flex-col min-h-screen">
        {% include "partials/_navbar.html" %}

        <!-- Toast Notifications -->
        {% if messages %}
        <div class="max-w-7xl mx-auto px-4 mt-4 w-full" x-data="{ toasts: true }" x-show="toasts" x-init="setTimeout(() => { $el.querySelectorAll('.toast-enter').forEach(t => t.classList.replace('toast-enter', 'toast-exit')); setTimeout(() => toasts = false, 300) }, 4000)">
            {% for message in messages %}
            <div class="toast-enter rounded-xl p-4 mb-2 backdrop-blur-md border flex items-center gap-3 {% if message.tags == 'success' %}bg-aurora/10 border-aurora/20 text-green-300 dark:text-green-200{% elif message.tags == 'error' %}bg-comet/10 border-comet/20 text-red-300 dark:text-red-200{% else %}bg-nebula-400/10 border-nebula-400/20 text-orange-300 dark:text-orange-200{% endif %}">
                {% if message.tags == 'success' %}<svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>{% elif message.tags == 'error' %}<svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>{% else %}<svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>{% endif %}
                <span>{{ message }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <main class="flex-1 max-w-7xl mx-auto px-4 py-6 w-full">
            {% block content %}{% endblock %}
        </main>

        <footer class="bg-white/5 dark:bg-white/5 backdrop-blur-md border-t border-white/10 py-4 mt-auto">
            <div class="max-w-7xl mx-auto px-4 text-center text-sm text-gray-400 dark:text-gray-500 flex items-center justify-center gap-2">
                {% include "partials/baku/_baku_icon.html" %}
                <span>&copy; 2025 <span class="brand-title">残音</span></span>
            </div>
        </footer>
    </div>

    {% if user.is_authenticated %}
    <!-- Achievement Toast Notifications -->
    <div hx-get="{% url 'dashboard:check_new_achievements' %}" hx-trigger="load, every 30s" hx-swap="afterbegin" hx-target="#achievement-toasts"></div>
    <div id="achievement-toasts" class="fixed top-20 right-6 z-[60] space-y-2 pointer-events-auto"></div>

    <!-- Chat Widget -->
    <div x-data="chatWidget()" x-cloak class="z-50">
        <!-- Toggle Button -->
        <button @click="toggle()"
                class="fixed w-14 h-14 rounded-full chat-toggle-btn
                       bg-cosmic-600/90 hover:bg-cosmic-500/90 text-white
                       shadow-glow-lg hover:shadow-glow
                       flex items-center justify-center
                       transition-all duration-300 hover:scale-110 z-50"
                :class="open ? 'rotate-0' : 'animate-pulse-glow'">
            <svg x-show="!open" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 0 1-2.555-.337A5.972 5.972 0 0 1 5.41 20.97a5.969 5.969 0 0 1-.474-.065 4.48 4.48 0 0 0 .978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25Z"/>
            </svg>
            <svg x-show="open" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12"/>
            </svg>
        </button>

        <!-- Chat Panel -->
        <div x-show="open"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 translate-y-4 scale-95"
             x-transition:enter-end="opacity-100 translate-y-0 scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 translate-y-0 scale-100"
             x-transition:leave-end="opacity-0 translate-y-4 scale-95"
             class="fixed h-[32rem] chat-panel
                    bg-cosmic-950/95 backdrop-blur-xl rounded-2xl
                    border border-white/10 shadow-2xl
                    flex flex-col overflow-hidden z-50">

            <!-- Header -->
            <div class="px-4 py-3 border-b border-white/10 flex items-center justify-between flex-shrink-0">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-aurora animate-pulse"></div>
                    <span class="font-display text-sm font-bold text-white/90">音楽理論チャット</span>
                </div>
                <div class="flex items-center gap-1">
                    <button @click="showHistory = !showHistory"
                            class="p-1.5 rounded-lg hover:bg-white/5 transition-colors text-white/50 hover:text-white/80"
                            title="会話履歴">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
                        </svg>
                    </button>
                    <button @click="newConversation()"
                            class="p-1.5 rounded-lg hover:bg-white/5 transition-colors text-white/50 hover:text-white/80"
                            title="新しい会話">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- History Panel (overlay) -->
            <div x-show="showHistory"
                 x-transition
                 class="absolute inset-0 top-[49px] bg-cosmic-950/98 backdrop-blur-xl z-10 overflow-y-auto"
                 @click.outside="showHistory = false">
                <div class="p-3">
                    <h3 class="text-xs font-bold text-white/40 uppercase tracking-wider mb-2 px-1">会話履歴</h3>
                    <div id="chat-history-list"
                         hx-get="{% url 'music_theory:chat_history' %}"
                         hx-trigger="intersect once"
                         hx-swap="innerHTML">
                        <div class="text-center py-6">
                            <div class="loading-spinner mx-auto"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Messages Area -->
            <div id="chat-messages"
                 class="flex-1 overflow-y-auto p-3 space-y-3"
                 x-ref="chatMessages">
                <!-- Empty state -->
                <div id="chat-empty-state" class="flex flex-col items-center justify-center h-full text-center px-4">
                    <svg class="w-10 h-10 text-cosmic-400/30 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2Zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2ZM9 10l12-3"/>
                    </svg>
                    <p class="text-sm text-white/30 font-display">音楽理論について<br>なんでも聞いてください</p>
                    <div class="mt-4 space-y-1.5">
                        <button @click="sendSuggestion('Cメジャーキーで明るいコード進行を教えて')"
                                class="block w-full text-left text-xs px-3 py-2 rounded-lg bg-white/5 border border-white/5 text-white/40 hover:text-white/70 hover:bg-white/10 transition-colors">
                            Cメジャーキーで明るいコード進行を教えて
                        </button>
                        <button @click="sendSuggestion('サビで感動的な雰囲気を出すにはどうすればいい？')"
                                class="block w-full text-left text-xs px-3 py-2 rounded-lg bg-white/5 border border-white/5 text-white/40 hover:text-white/70 hover:bg-white/10 transition-colors">
                            サビで感動的な雰囲気を出すには？
                        </button>
                        <button @click="sendSuggestion('ペンタトニックスケールの使い方を教えて')"
                                class="block w-full text-left text-xs px-3 py-2 rounded-lg bg-white/5 border border-white/5 text-white/40 hover:text-white/70 hover:bg-white/10 transition-colors">
                            ペンタトニックスケールの使い方を教えて
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading indicator -->
            <div id="chat-loading" class="hidden px-4 py-2 flex-shrink-0">
                <div class="flex items-center gap-2 text-white/30">
                    <div class="flex gap-1">
                        <div class="w-1.5 h-1.5 rounded-full bg-cosmic-400 animate-bounce" style="animation-delay: 0ms"></div>
                        <div class="w-1.5 h-1.5 rounded-full bg-cosmic-400 animate-bounce" style="animation-delay: 150ms"></div>
                        <div class="w-1.5 h-1.5 rounded-full bg-cosmic-400 animate-bounce" style="animation-delay: 300ms"></div>
                    </div>
                    <span class="text-xs">考え中...</span>
                </div>
            </div>

            <!-- Input Form -->
            <form id="chat-form"
                  hx-post="{% url 'music_theory:chat_send' %}"
                  hx-target="#chat-messages"
                  hx-swap="beforeend"
                  hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                  hx-indicator="#chat-loading"
                  @htmx:before-request.window="onBeforeRequest($event)"
                  @htmx:after-request.window="onAfterRequest($event)"
                  class="p-3 border-t border-white/10 flex-shrink-0">
                <input type="hidden" name="conversation_id" :value="conversationId">
                <div class="flex gap-2">
                    <input type="text" name="message" x-ref="chatInput"
                           placeholder="作曲について質問..."
                           autocomplete="off"
                           class="flex-1 !bg-white/5 !border-white/10 !rounded-xl !text-sm !py-2.5 !px-3
                                  focus:!border-cosmic-500/50 focus:!shadow-none !text-white/90"
                           @keydown.enter.prevent="$el.closest('form').requestSubmit()">
                    <button type="submit"
                            class="px-3 py-2 rounded-xl bg-cosmic-600/80 hover:bg-cosmic-500/80
                                   text-white/90 transition-all duration-200 hover:scale-105
                                   disabled:opacity-30 disabled:hover:scale-100"
                            :disabled="sending">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5"/>
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
    function chatWidget() {
        return {
            open: false,
            conversationId: null,
            showHistory: false,
            sending: false,

            toggle() {
                this.open = !this.open;
                if (this.open) {
                    this.$nextTick(() => this.$refs.chatInput?.focus());
                }
            },

            newConversation() {
                this.conversationId = null;
                this.showHistory = false;
                const msgArea = document.getElementById('chat-messages');
                msgArea.innerHTML = document.getElementById('chat-empty-state-template')?.innerHTML || '';
                this.resetEmptyState();
            },

            resetEmptyState() {
                const msgArea = document.getElementById('chat-messages');
                msgArea.innerHTML = `
                    <div id="chat-empty-state" class="flex flex-col items-center justify-center h-full text-center px-4">
                        <svg class="w-10 h-10 text-cosmic-400/30 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2Zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2ZM9 10l12-3"/>
                        </svg>
                        <p class="text-sm text-white/30 font-display">音楽理論について<br>なんでも聞いてください</p>
                    </div>`;
            },

            loadConversation(id) {
                this.conversationId = id;
                this.showHistory = false;
                const msgArea = document.getElementById('chat-messages');
                msgArea.innerHTML = '<div class="flex justify-center py-8"><div class="loading-spinner"></div></div>';
                htmx.ajax('GET', '/theory/chat/' + id + '/', {target: '#chat-messages', swap: 'innerHTML'}).then(() => {
                    this.scrollToBottom();
                });
            },

            sendSuggestion(text) {
                this.$refs.chatInput.value = text;
                const emptyState = document.getElementById('chat-empty-state');
                if (emptyState) emptyState.remove();
                this.$refs.chatInput.closest('form').requestSubmit();
            },

            onBeforeRequest(event) {
                if (event.detail.elt.id !== 'chat-form') return;
                this.sending = true;
                const emptyState = document.getElementById('chat-empty-state');
                if (emptyState) emptyState.remove();
                document.getElementById('chat-loading').classList.remove('hidden');
            },

            onAfterRequest(event) {
                if (event.detail.elt.id !== 'chat-form') return;
                this.sending = false;
                document.getElementById('chat-loading').classList.add('hidden');
                this.$refs.chatInput.value = '';
                this.$nextTick(() => this.scrollToBottom());

                // Extract conversation ID from HX-Trigger
                const trigger = event.detail.xhr?.getResponseHeader('HX-Trigger');
                if (trigger) {
                    try {
                        const data = JSON.parse(trigger);
                        if (data.chatConversationId) {
                            this.conversationId = data.chatConversationId;
                        }
                    } catch(e) {}
                }
            },

            scrollToBottom() {
                const el = document.getElementById('chat-messages');
                if (el) {
                    this.$nextTick(() => {
                        el.scrollTop = el.scrollHeight;
                    });
                }
            }
        }
    }
    </script>
    {% endif %}

    <!-- HTMX Progress Bar Script -->
    <script>
        (function() {
            const bar = document.getElementById('htmx-progress');
            document.body.addEventListener('htmx:beforeRequest', function() {
                bar.classList.remove('done', 'fade');
                bar.classList.add('active');
            });
            document.body.addEventListener('htmx:afterRequest', function() {
                bar.classList.remove('active');
                bar.classList.add('done');
                setTimeout(() => bar.classList.add('fade'), 200);
                setTimeout(() => bar.classList.remove('done', 'fade'), 700);
            });
        })();
    </script>

    {% block extra_js %}{% endblock %}

    <!-- Service Worker & Push Notifications -->
    <script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
            .then(function(registration) {
                {% if user.is_authenticated %}
                setupPushNotifications(registration);
                {% endif %}
            })
            .catch(() => {});
    }

    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
    }

    async function setupPushNotifications(registration) {
        try {
            const resp = await fetch('{% url "dashboard:vapid_public_key" %}');
            const data = await resp.json();
            if (!data.publicKey) return;

            let subscription = await registration.pushManager.getSubscription();
            if (!subscription) {
                subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(data.publicKey),
                });
            }

            await fetch('{% url "dashboard:push_subscribe" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify(subscription.toJSON()),
            });
        } catch(e) {
            // Push not supported or permission denied
        }
    }
    </script>
</body>
</html>
