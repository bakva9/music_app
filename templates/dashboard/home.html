{% extends "base.html" %}

{% block title %}残音 - ダッシュボード{% endblock %}

{% block content %}
<div class="text-center mb-10">
    <div class="w-24 h-24 mx-auto mb-4 animate-float">
        {% include "partials/baku/_baku_greeting.html" %}
    </div>
    <h1 class="brand-title-glow mb-2">
        <span class="brand-title font-display text-3xl font-bold tracking-[0.15em]">残音</span>
    </h1>
    <p class="text-cosmic-600/60 dark:text-white/50 font-display">現実の音がここにある。</p>
</div>

<!-- App Navigation Cards -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
    <a href="{% url 'music_theory:topic_list' %}"
       class="group block bg-white/80 dark:bg-white/5 backdrop-blur-md rounded-2xl p-6 border border-cosmic-200/30 dark:border-white/10
              hover:border-cosmic-400/30 dark:hover:border-cosmic-400/30 hover:shadow-[0_8px_40px_rgba(199,48,88,0.15)]
              transition-all duration-300 hover:-translate-y-1 hover:scale-[1.02]
              animate-scale-in" style="animation-delay: 0ms; animation-fill-mode: both;">
        <div class="w-12 h-12 rounded-xl bg-cosmic-500/10 dark:bg-cosmic-500/15 flex items-center justify-center mb-3 group-hover:bg-cosmic-500/20 group-hover:scale-110 group-hover:-rotate-3 transition-all duration-200">
            <svg class="w-6 h-6 text-cosmic-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 19V6l12-3v13"/>
                <circle cx="6" cy="19" r="3"/><circle cx="18" cy="16" r="3"/>
            </svg>
        </div>
        <h2 class="font-display text-lg font-bold mb-1 text-cosmic-800 dark:text-white/90 group-hover:text-cosmic-600 dark:group-hover:text-cosmic-300 transition-colors">音楽理論</h2>
        <p class="text-sm text-cosmic-600/60 dark:text-white/50">スケール・コード・進行などの音楽理論を検索。ブックマーク＆メモで学習をサポート。</p>
    </a>

    <a href="{% url 'guitarlog:home' %}"
       class="group block bg-white/80 dark:bg-white/5 backdrop-blur-md rounded-2xl p-6 border border-cosmic-200/30 dark:border-white/10
              hover:border-nebula-400/30 dark:hover:border-nebula-400/30 hover:shadow-[0_8px_40px_rgba(240,112,32,0.15)]
              transition-all duration-300 hover:-translate-y-1 hover:scale-[1.02]
              animate-scale-in" style="animation-delay: 100ms; animation-fill-mode: both;">
        <div class="w-12 h-12 rounded-xl bg-nebula-500/10 dark:bg-nebula-500/15 flex items-center justify-center mb-3 group-hover:bg-nebula-500/20 group-hover:scale-110 group-hover:-rotate-3 transition-all duration-200">
            <svg class="w-6 h-6 text-nebula-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
            </svg>
        </div>
        <h2 class="font-display text-lg font-bold mb-1 text-cosmic-800 dark:text-white/90 group-hover:text-nebula-600 dark:group-hover:text-nebula-300 transition-colors">練習記録</h2>
        <p class="text-sm text-cosmic-600/60 dark:text-white/50">ギター練習の時間を記録。ストリークで継続をモチベーションに。</p>
    </a>

    <a href="{% url 'livelog:event_list' %}"
       class="group block bg-white/80 dark:bg-white/5 backdrop-blur-md rounded-2xl p-6 border border-cosmic-200/30 dark:border-white/10
              hover:border-orange-400/30 dark:hover:border-orange-400/30 hover:shadow-[0_8px_40px_rgba(255,159,67,0.15)]
              transition-all duration-300 hover:-translate-y-1 hover:scale-[1.02]
              animate-scale-in" style="animation-delay: 200ms; animation-fill-mode: both;">
        <div class="w-12 h-12 rounded-xl bg-orange-500/10 dark:bg-orange-500/15 flex items-center justify-center mb-3 group-hover:bg-orange-500/20 group-hover:scale-110 group-hover:-rotate-3 transition-all duration-200">
            <svg class="w-6 h-6 text-orange-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M15 2H9a2 2 0 0 0-2 2v6a5 5 0 0 0 10 0V4a2 2 0 0 0-2-2Z"/><path d="M12 15v4"/><path d="M8 19h8"/>
            </svg>
        </div>
        <h2 class="font-display text-lg font-bold mb-1 text-cosmic-800 dark:text-white/90 group-hover:text-orange-600 dark:group-hover:text-orange-300 transition-colors">ライブ記録</h2>
        <p class="text-sm text-cosmic-600/60 dark:text-white/50">ライブの思い出を記録。セトリ・感想・費用をまとめて管理。</p>
    </a>

    <a href="{% url 'songdiary:project_list' %}"
       class="group block bg-white/80 dark:bg-white/5 backdrop-blur-md rounded-2xl p-6 border border-cosmic-200/30 dark:border-white/10
              hover:border-green-400/30 dark:hover:border-green-400/30 hover:shadow-[0_8px_40px_rgba(0,255,136,0.1)]
              transition-all duration-300 hover:-translate-y-1 hover:scale-[1.02]
              animate-scale-in" style="animation-delay: 300ms; animation-fill-mode: both;">
        <div class="w-12 h-12 rounded-xl bg-green-500/10 dark:bg-green-500/15 flex items-center justify-center mb-3 group-hover:bg-green-500/20 group-hover:scale-110 group-hover:-rotate-3 transition-all duration-200">
            <svg class="w-6 h-6 text-green-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
        </div>
        <h2 class="font-display text-lg font-bold mb-1 text-cosmic-800 dark:text-white/90 group-hover:text-green-600 dark:group-hover:text-green-300 transition-colors">作曲管理</h2>
        <p class="text-sm text-cosmic-600/60 dark:text-white/50">作曲プロジェクトの進捗を管理。テキスト・音声・写真メモで記録。</p>
    </a>
</div>

{% if user.is_authenticated %}
<!-- Stats Cards -->
<div class="mt-12 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"
     x-data="{ shown: false }"
     x-intersect.once="shown = true">
    <div class="bg-white/80 dark:bg-white/5 backdrop-blur-md rounded-2xl p-5 border border-cosmic-200/30 dark:border-white/10 text-center border-t-2 border-t-cosmic-400
                transition-all duration-300 hover:shadow-[0_4px_20px_rgba(199,48,88,0.1)]">
        <div class="text-xl sm:text-2xl font-mono font-bold text-cosmic-600 dark:text-cosmic-300"
             x-data="{ count: 0, target: {{ bookmark_count|default:0 }} }"
             x-init="if(shown) { let i = setInterval(() => { if(count >= target) clearInterval(i); else count++ }, 50) }"
             x-effect="if(shown && count === 0 && target > 0) { let i = setInterval(() => { if(count >= target) clearInterval(i); else count++ }, 50) }"
             x-text="count">{{ bookmark_count|default:0 }}</div>
        <div class="text-sm text-cosmic-600/60 dark:text-white/50 font-display mt-1">ブックマーク</div>
    </div>
    <div class="bg-white/80 dark:bg-white/5 backdrop-blur-md rounded-2xl p-5 border border-cosmic-200/30 dark:border-white/10 text-center border-t-2 border-t-nebula-400
                transition-all duration-300 hover:shadow-[0_4px_20px_rgba(240,112,32,0.1)]">
        <div class="text-xl sm:text-2xl font-mono font-bold text-nebula-600 dark:text-nebula-300"
             x-data="{ count: 0, target: {{ streak_count|default:0 }} }"
             x-init="if(shown) { let i = setInterval(() => { if(count >= target) clearInterval(i); else count++ }, 50) }"
             x-effect="if(shown && count === 0 && target > 0) { let i = setInterval(() => { if(count >= target) clearInterval(i); else count++ }, 50) }"
             x-text="count + '日'">{{ streak_count|default:0 }}日</div>
        <div class="text-sm text-cosmic-600/60 dark:text-white/50 font-display mt-1">練習ストリーク</div>
    </div>
    <div class="bg-white/80 dark:bg-white/5 backdrop-blur-md rounded-2xl p-5 border border-cosmic-200/30 dark:border-white/10 text-center border-t-2 border-t-supernova
                transition-all duration-300 hover:shadow-[0_4px_20px_rgba(255,159,67,0.1)]">
        <div class="text-xl sm:text-2xl font-mono font-bold text-supernova dark:text-supernova"
             x-data="{ count: 0, target: {{ live_count|default:0 }} }"
             x-init="if(shown) { let i = setInterval(() => { if(count >= target) clearInterval(i); else count++ }, 50) }"
             x-effect="if(shown && count === 0 && target > 0) { let i = setInterval(() => { if(count >= target) clearInterval(i); else count++ }, 50) }"
             x-text="count">{{ live_count|default:0 }}</div>
        <div class="text-sm text-cosmic-600/60 dark:text-white/50 font-display mt-1">ライブ参戦数</div>
    </div>
    <div class="bg-white/80 dark:bg-white/5 backdrop-blur-md rounded-2xl p-5 border border-cosmic-200/30 dark:border-white/10 text-center border-t-2 border-t-aurora
                transition-all duration-300 hover:shadow-[0_4px_20px_rgba(0,255,136,0.1)]">
        <div class="text-xl sm:text-2xl font-mono font-bold text-green-600 dark:text-aurora"
             x-data="{ count: 0, target: {{ project_count|default:0 }} }"
             x-init="if(shown) { let i = setInterval(() => { if(count >= target) clearInterval(i); else count++ }, 50) }"
             x-effect="if(shown && count === 0 && target > 0) { let i = setInterval(() => { if(count >= target) clearInterval(i); else count++ }, 50) }"
             x-text="count">{{ project_count|default:0 }}</div>
        <div class="text-sm text-cosmic-600/60 dark:text-white/50 font-display mt-1">作曲プロジェクト</div>
    </div>
</div>

<!-- Practice Week Chart + Quick Actions -->
<div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Mini Practice Graph -->
    <div class="bg-white/80 dark:bg-white/5 backdrop-blur-md rounded-2xl p-5 border border-cosmic-200/30 dark:border-white/10">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-display font-bold text-cosmic-800 dark:text-white/90">今週の練習</h3>
            <span class="text-xs font-mono text-cosmic-600/60 dark:text-white/40">累計 {{ total_minutes|default:0 }}分</span>
        </div>
        <div class="flex items-end justify-between gap-1.5 h-24">
            {% for day in practice_week %}
            <div class="flex-1 flex flex-col items-center gap-1">
                <div class="w-full rounded-t-md transition-all duration-500 relative group
                            {% if day.minutes > 0 %}bg-gradient-to-t from-cosmic-500 to-nebula-400{% else %}bg-white/10 dark:bg-white/5{% endif %}"
                     style="height: {% if day.pct > 0 %}{{ day.pct }}%{% else %}4px{% endif %}; min-height: 4px;">
                    {% if day.minutes > 0 %}
                    <div class="absolute -top-6 left-1/2 -translate-x-1/2 text-[10px] font-mono text-cosmic-600 dark:text-white/50 opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">{{ day.minutes }}分</div>
                    {% endif %}
                </div>
                <span class="text-[10px] text-cosmic-600/50 dark:text-white/30">{{ day.label }}</span>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="bg-white/80 dark:bg-white/5 backdrop-blur-md rounded-2xl p-5 border border-cosmic-200/30 dark:border-white/10">
        <h3 class="font-display font-bold text-cosmic-800 dark:text-white/90 mb-4">クイックアクション</h3>
        <div class="grid grid-cols-2 gap-3">
            <a href="{% url 'guitarlog:timer' %}" class="flex items-center gap-3 p-3 rounded-xl bg-nebula-500/10 dark:bg-nebula-500/10 border border-nebula-400/20 hover:bg-nebula-500/20 transition-all duration-200">
                <div class="w-8 h-8 rounded-lg bg-nebula-500/20 flex items-center justify-center">
                    <svg class="w-4 h-4 text-nebula-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                </div>
                <span class="text-sm font-medium text-cosmic-800 dark:text-white/80">練習を始める</span>
            </a>
            <a href="{% url 'livelog:event_create' %}" class="flex items-center gap-3 p-3 rounded-xl bg-orange-500/10 dark:bg-orange-500/10 border border-orange-400/20 hover:bg-orange-500/20 transition-all duration-200">
                <div class="w-8 h-8 rounded-lg bg-orange-500/20 flex items-center justify-center">
                    <svg class="w-4 h-4 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>
                </div>
                <span class="text-sm font-medium text-cosmic-800 dark:text-white/80">ライブを追加</span>
            </a>
            <a href="{% url 'songdiary:project_create' %}" class="flex items-center gap-3 p-3 rounded-xl bg-green-500/10 dark:bg-green-500/10 border border-green-400/20 hover:bg-green-500/20 transition-all duration-200">
                <div class="w-8 h-8 rounded-lg bg-green-500/20 flex items-center justify-center">
                    <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>
                </div>
                <span class="text-sm font-medium text-cosmic-800 dark:text-white/80">作曲を始める</span>
            </a>
            <a href="{% url 'guitarlog:quick_record' %}" class="flex items-center gap-3 p-3 rounded-xl bg-cosmic-500/10 dark:bg-cosmic-500/10 border border-cosmic-400/20 hover:bg-cosmic-500/20 transition-all duration-200">
                <div class="w-8 h-8 rounded-lg bg-cosmic-500/20 flex items-center justify-center">
                    <svg class="w-4 h-4 text-cosmic-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                </div>
                <span class="text-sm font-medium text-cosmic-800 dark:text-white/80">かんたん記録</span>
            </a>
        </div>
    </div>
</div>

<!-- Achievements Summary -->
{% if recent_achievements %}
<div class="mt-8">
    <div class="flex justify-between items-center mb-3">
        <h3 class="font-display font-bold text-cosmic-800 dark:text-white/90">獲得した実績</h3>
        <a href="{% url 'dashboard:achievement_list' %}" class="text-xs text-cosmic-500 dark:text-cosmic-300 hover:text-cosmic-400 transition-colors">すべて見る &rarr;</a>
    </div>
    <div class="flex flex-wrap gap-3">
        {% for ua in recent_achievements %}
        <div class="group flex items-center gap-2 px-3 py-2 bg-white/80 dark:bg-white/5 backdrop-blur-md rounded-xl border border-stardust/20 hover:border-stardust/40 transition-all duration-200 hover:shadow-[0_2px_12px_rgba(255,215,0,0.1)]"
             title="{{ ua.achievement.description }}">
            <div class="w-7 h-7 rounded-lg bg-gradient-to-br from-stardust/20 to-cosmic-500/20 flex items-center justify-center text-stardust">
                {% include "dashboard/_badge_icons.html" with icon=ua.achievement.icon_name size="w-3.5 h-3.5" %}
            </div>
            <span class="text-xs font-display font-bold text-white/70 group-hover:text-white/90 transition-colors">{{ ua.achievement.name }}</span>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Activity Heatmap (GitHub-style) -->
<div class="mt-8 bg-white/80 dark:bg-white/5 backdrop-blur-md rounded-2xl p-5 border border-cosmic-200/30 dark:border-white/10"
     x-data="calendarHeatmap()" x-init="loadData()">
    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 mb-4">
        <h3 class="font-display font-bold text-cosmic-800 dark:text-white/90">アクティビティ</h3>
        <div class="flex items-center gap-3">
            <span class="text-xs font-mono text-cosmic-600/60 dark:text-white/40" x-text="activeCount + '日アクティブ'"></span>
            <div class="flex items-center gap-1 text-[10px] text-cosmic-600/50 dark:text-white/30">
                <span>少</span>
                <span class="inline-block w-2.5 h-2.5 rounded-sm bg-white/5 dark:bg-white/5"></span>
                <span class="inline-block w-2.5 h-2.5 rounded-sm bg-cosmic-500/30"></span>
                <span class="inline-block w-2.5 h-2.5 rounded-sm bg-cosmic-500/50"></span>
                <span class="inline-block w-2.5 h-2.5 rounded-sm bg-cosmic-500/70"></span>
                <span class="inline-block w-2.5 h-2.5 rounded-sm bg-cosmic-500"></span>
                <span>多</span>
            </div>
        </div>
    </div>

    <!-- Month labels -->
    <div class="overflow-x-auto pb-1">
        <div class="min-w-[680px]">
            <div class="flex mb-1 ml-8" style="gap: 2px;">
                <template x-for="m in monthLabels" :key="m.col">
                    <span class="text-[9px] text-cosmic-600/40 dark:text-white/25 absolute"
                          :style="'left: ' + (m.col * 12.5 + 32) + 'px'" x-text="m.label"></span>
                </template>
            </div>
            <div class="relative" style="padding-top: 14px;">
                <!-- Day of week labels -->
                <div class="absolute left-0 top-[14px] flex flex-col" style="gap: 2px;">
                    <span class="h-[10px] text-[9px] leading-[10px] text-cosmic-600/40 dark:text-white/25 w-7"></span>
                    <span class="h-[10px] text-[9px] leading-[10px] text-cosmic-600/40 dark:text-white/25 w-7">Mon</span>
                    <span class="h-[10px] text-[9px] leading-[10px] text-cosmic-600/40 dark:text-white/25 w-7"></span>
                    <span class="h-[10px] text-[9px] leading-[10px] text-cosmic-600/40 dark:text-white/25 w-7">Wed</span>
                    <span class="h-[10px] text-[9px] leading-[10px] text-cosmic-600/40 dark:text-white/25 w-7"></span>
                    <span class="h-[10px] text-[9px] leading-[10px] text-cosmic-600/40 dark:text-white/25 w-7">Fri</span>
                    <span class="h-[10px] text-[9px] leading-[10px] text-cosmic-600/40 dark:text-white/25 w-7"></span>
                </div>
                <!-- Heatmap grid -->
                <div class="ml-8 grid grid-flow-col" style="grid-template-rows: repeat(7, 10px); gap: 2px;">
                    <template x-for="(day, idx) in cells" :key="idx">
                        <div class="w-[10px] h-[10px] rounded-sm cursor-pointer transition-all duration-150 hover:ring-1 hover:ring-white/30"
                             :class="levelClass(day.level)"
                             :title="day.date + ': ' + day.tip"
                             @click="selectDay(day.date)"
                             :style="day.empty ? 'visibility:hidden' : ''">
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Day detail panel -->
    <div id="calendar-day-detail" class="mt-3" x-show="selectedDay" x-cloak>
    </div>
</div>

<script>
function calendarHeatmap() {
    return {
        cells: [],
        activeCount: 0,
        monthLabels: [],
        selectedDay: null,

        async loadData() {
            try {
                const resp = await fetch('{% url "dashboard:calendar_data" %}');
                const data = await resp.json();
                this.activeCount = data.active_count;
                this.buildGrid(data.days, data.start);
            } catch(e) {
                console.error('Calendar load error:', e);
            }
        },

        buildGrid(days, startStr) {
            const start = new Date(startStr + 'T00:00:00');
            const startDow = start.getDay() === 0 ? 6 : start.getDay() - 1; // Monday=0

            // Pad empty cells for the first partial week
            const cells = [];
            for (let i = 0; i < startDow; i++) {
                cells.push({ empty: true, level: 0, date: '', tip: '' });
            }

            // Month labels
            const months = [];
            let lastMonth = -1;

            days.forEach((d, idx) => {
                const dt = new Date(d.date + 'T00:00:00');
                const m = dt.getMonth();
                if (m !== lastMonth) {
                    const col = Math.floor((idx + startDow) / 7);
                    const labels = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                    months.push({ col, label: labels[m] });
                    lastMonth = m;
                }

                let tip = '';
                const parts = [];
                if (d.practice > 0) parts.push(d.practice + '分練習');
                if (d.live > 0) parts.push('ライブ' + d.live + '件');
                if (d.compose > 0) parts.push('作曲' + d.compose + '件');
                tip = parts.length ? parts.join(', ') : 'アクティビティなし';

                cells.push({
                    empty: false,
                    level: d.level,
                    date: d.date,
                    tip: tip,
                });
            });

            this.cells = cells;
            this.monthLabels = months;
        },

        levelClass(level) {
            const classes = [
                'bg-white/[0.03] dark:bg-white/[0.03]',
                'bg-cosmic-500/30',
                'bg-cosmic-500/50',
                'bg-cosmic-500/70',
                'bg-cosmic-500 shadow-[0_0_4px_rgba(199,48,88,0.3)]',
            ];
            return classes[level] || classes[0];
        },

        selectDay(dateStr) {
            if (!dateStr) return;
            this.selectedDay = dateStr;
            htmx.ajax('GET', '/calendar/day/' + dateStr + '/', {
                target: '#calendar-day-detail',
                swap: 'innerHTML',
            });
        },
    };
}
</script>

<!-- AI Practice Advice Widget -->
<div class="mt-8 bg-white/80 dark:bg-white/5 backdrop-blur-md rounded-2xl p-5 border border-cosmic-200/30 dark:border-white/10">
    <div class="flex items-center gap-2 mb-3">
        <div class="w-7 h-7 rounded-lg bg-gradient-to-br from-cosmic-500/20 to-nebula-500/20 flex items-center justify-center">
            <svg class="w-4 h-4 text-cosmic-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.455 2.456L21.75 6l-1.036.259a3.375 3.375 0 0 0-2.455 2.456Z"/>
            </svg>
        </div>
        <h3 class="font-display font-bold text-cosmic-800 dark:text-white/90">AIアドバイス</h3>
    </div>
    <div id="advice-widget"
         hx-get="{% url 'dashboard:practice_advice' %}"
         hx-trigger="load"
         hx-swap="innerHTML">
        <div class="flex justify-center py-4">
            <div class="loading-spinner"></div>
        </div>
    </div>
</div>

<!-- Recent Activity Feed -->
{% if activities %}
<div class="mt-8">
    <h3 class="font-display font-bold text-cosmic-800 dark:text-white/90 mb-4">最近のアクティビティ</h3>
    <div class="bg-white/80 dark:bg-white/5 backdrop-blur-md rounded-2xl border border-cosmic-200/30 dark:border-white/10 divide-y divide-cosmic-200/20 dark:divide-white/5">
        {% for activity in activities %}
        <a href="{{ activity.url }}" class="flex items-center gap-3 px-5 py-3.5 hover:bg-white/50 dark:hover:bg-white/5 transition-colors first:rounded-t-2xl last:rounded-b-2xl">
            <div class="w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0
                        {% if activity.type == 'practice' %}bg-nebula-500/15
                        {% elif activity.type == 'live' %}bg-orange-500/15
                        {% elif activity.type == 'project' %}bg-green-500/15
                        {% else %}bg-cosmic-500/15{% endif %}">
                {% if activity.type == 'practice' %}
                <svg class="w-4 h-4 text-nebula-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                {% elif activity.type == 'live' %}
                <svg class="w-4 h-4 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path d="M15 2H9a2 2 0 0 0-2 2v6a5 5 0 0 0 10 0V4a2 2 0 0 0-2-2Z"/><path d="M12 15v4"/><path d="M8 19h8"/></svg>
                {% elif activity.type == 'project' %}
                <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                {% else %}
                <svg class="w-4 h-4 text-cosmic-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.25 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0 1 11.186 0Z"/></svg>
                {% endif %}
            </div>
            <div class="flex-1 min-w-0">
                <p class="text-sm text-cosmic-800 dark:text-white/80 truncate">{{ activity.text }}</p>
            </div>
            <time class="text-xs text-cosmic-600/50 dark:text-white/30 flex-shrink-0">{{ activity.date|timesince }}前</time>
        </a>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endif %}
{% endblock %}
