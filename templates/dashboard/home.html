{% extends "base.html" %}

{% block title %}残音 - ダッシュボード{% endblock %}

{% block content %}
<!-- Compact Hero -->
<div class="flex items-center gap-3 mb-6">
    <div class="w-12 h-12 flex-shrink-0 animate-float">
        {% include "partials/baku/_baku_greeting.html" %}
    </div>
    <div>
        <h1 class="font-display text-xl font-bold text-cosmic-800 dark:text-white text-glow tracking-wide">残音</h1>
        <p class="text-xs text-cosmic-600/60 dark:text-white/50 font-display">現実の音がここにある。</p>
    </div>
</div>

<!-- Nav Cards with integrated stats -->
<div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-6">
    <a href="{% url 'music_theory:topic_list' %}"
       class="group block bg-white/80 dark:bg-white/5 backdrop-blur-md rounded-2xl p-4 border border-cosmic-200/30 dark:border-white/10
              hover:border-cosmic-400/30 dark:hover:border-cosmic-400/30 hover:shadow-[0_8px_40px_rgba(199,48,88,0.15)]
              transition-all duration-300 hover:-translate-y-1
              animate-scale-in" style="animation-delay: 0ms; animation-fill-mode: both;">
        <div class="flex items-center justify-between mb-2">
            <div class="w-9 h-9 rounded-lg bg-cosmic-500/10 dark:bg-cosmic-500/15 flex items-center justify-center group-hover:bg-cosmic-500/20 group-hover:scale-110 transition-all duration-200">
                <svg class="w-5 h-5 text-cosmic-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 19V6l12-3v13"/><circle cx="6" cy="19" r="3"/><circle cx="18" cy="16" r="3"/>
                </svg>
            </div>
            {% if user.is_authenticated %}
            <div class="text-right">
                <span class="text-lg font-mono font-bold text-cosmic-500 dark:text-cosmic-300 leading-none">{{ bookmark_count|default:0 }}</span>
                <div class="text-[10px] text-cosmic-600/40 dark:text-white/30">ブックマーク</div>
            </div>
            {% endif %}
        </div>
        <h2 class="font-display text-sm font-bold text-cosmic-800 dark:text-white/90">音楽理論</h2>
        <p class="text-xs text-cosmic-600/50 dark:text-white/40 mt-0.5 hidden sm:block">スケール・コード・進行</p>
    </a>

    <a href="{% url 'guitarlog:home' %}"
       class="group block bg-white/80 dark:bg-white/5 backdrop-blur-md rounded-2xl p-4 border border-cosmic-200/30 dark:border-white/10
              hover:border-nebula-400/30 dark:hover:border-nebula-400/30 hover:shadow-[0_8px_40px_rgba(240,112,32,0.15)]
              transition-all duration-300 hover:-translate-y-1
              animate-scale-in" style="animation-delay: 80ms; animation-fill-mode: both;">
        <div class="flex items-center justify-between mb-2">
            <div class="w-9 h-9 rounded-lg bg-nebula-500/10 dark:bg-nebula-500/15 flex items-center justify-center group-hover:bg-nebula-500/20 group-hover:scale-110 transition-all duration-200">
                <svg class="w-5 h-5 text-nebula-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                </svg>
            </div>
            {% if user.is_authenticated %}
            <div class="text-right">
                <span class="text-lg font-mono font-bold text-nebula-500 dark:text-nebula-300 leading-none">{{ streak_count|default:0 }}<small class="text-xs">日</small></span>
                <div class="text-[10px] text-cosmic-600/40 dark:text-white/30">ストリーク</div>
            </div>
            {% endif %}
        </div>
        <h2 class="font-display text-sm font-bold text-cosmic-800 dark:text-white/90">練習記録</h2>
        <p class="text-xs text-cosmic-600/50 dark:text-white/40 mt-0.5 hidden sm:block">ストリーク継続中</p>
    </a>

    <a href="{% url 'livelog:event_list' %}"
       class="group block bg-white/80 dark:bg-white/5 backdrop-blur-md rounded-2xl p-4 border border-cosmic-200/30 dark:border-white/10
              hover:border-orange-400/30 dark:hover:border-orange-400/30 hover:shadow-[0_8px_40px_rgba(255,159,67,0.15)]
              transition-all duration-300 hover:-translate-y-1
              animate-scale-in" style="animation-delay: 160ms; animation-fill-mode: both;">
        <div class="flex items-center justify-between mb-2">
            <div class="w-9 h-9 rounded-lg bg-orange-500/10 dark:bg-orange-500/15 flex items-center justify-center group-hover:bg-orange-500/20 group-hover:scale-110 transition-all duration-200">
                <svg class="w-5 h-5 text-orange-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M15 2H9a2 2 0 0 0-2 2v6a5 5 0 0 0 10 0V4a2 2 0 0 0-2-2Z"/><path d="M12 15v4"/><path d="M8 19h8"/>
                </svg>
            </div>
            {% if user.is_authenticated %}
            <div class="text-right">
                <span class="text-lg font-mono font-bold text-supernova leading-none">{{ live_count|default:0 }}</span>
                <div class="text-[10px] text-cosmic-600/40 dark:text-white/30">参戦回数</div>
            </div>
            {% endif %}
        </div>
        <h2 class="font-display text-sm font-bold text-cosmic-800 dark:text-white/90">ライブ記録</h2>
        <p class="text-xs text-cosmic-600/50 dark:text-white/40 mt-0.5 hidden sm:block">セトリ・感想・費用</p>
    </a>

    <a href="{% url 'songdiary:project_list' %}"
       class="group block bg-white/80 dark:bg-white/5 backdrop-blur-md rounded-2xl p-4 border border-cosmic-200/30 dark:border-white/10
              hover:border-green-400/30 dark:hover:border-green-400/30 hover:shadow-[0_8px_40px_rgba(0,255,136,0.1)]
              transition-all duration-300 hover:-translate-y-1
              animate-scale-in" style="animation-delay: 240ms; animation-fill-mode: both;">
        <div class="flex items-center justify-between mb-2">
            <div class="w-9 h-9 rounded-lg bg-green-500/10 dark:bg-green-500/15 flex items-center justify-center group-hover:bg-green-500/20 group-hover:scale-110 transition-all duration-200">
                <svg class="w-5 h-5 text-green-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
            </div>
            {% if user.is_authenticated %}
            <div class="text-right">
                <span class="text-lg font-mono font-bold text-green-500 dark:text-aurora leading-none">{{ project_count|default:0 }}</span>
                <div class="text-[10px] text-cosmic-600/40 dark:text-white/30">プロジェクト</div>
            </div>
            {% endif %}
        </div>
        <h2 class="font-display text-sm font-bold text-cosmic-800 dark:text-white/90">作曲管理</h2>
        <p class="text-xs text-cosmic-600/50 dark:text-white/40 mt-0.5 hidden sm:block">テキスト・音声・写真</p>
    </a>
</div>

{% if user.is_authenticated %}
<!-- Quick Actions (horizontal) -->
<div class="grid grid-cols-4 gap-2 mb-6">
    <a href="{% url 'guitarlog:timer' %}" class="flex flex-col items-center gap-1.5 p-3 rounded-xl bg-nebula-500/10 dark:bg-nebula-500/10 border border-nebula-400/20 hover:bg-nebula-500/20 transition-all duration-200">
        <div class="w-8 h-8 rounded-lg bg-nebula-500/20 flex items-center justify-center">
            <svg class="w-4 h-4 text-nebula-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
        </div>
        <span class="text-[10px] sm:text-xs font-medium text-cosmic-800 dark:text-white/80 text-center">練習開始</span>
    </a>
    <a href="{% url 'guitarlog:quick_record' %}" class="flex flex-col items-center gap-1.5 p-3 rounded-xl bg-cosmic-500/10 dark:bg-cosmic-500/10 border border-cosmic-400/20 hover:bg-cosmic-500/20 transition-all duration-200">
        <div class="w-8 h-8 rounded-lg bg-cosmic-500/20 flex items-center justify-center">
            <svg class="w-4 h-4 text-cosmic-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        </div>
        <span class="text-[10px] sm:text-xs font-medium text-cosmic-800 dark:text-white/80 text-center">かんたん記録</span>
    </a>
    <a href="{% url 'livelog:event_create' %}" class="flex flex-col items-center gap-1.5 p-3 rounded-xl bg-orange-500/10 dark:bg-orange-500/10 border border-orange-400/20 hover:bg-orange-500/20 transition-all duration-200">
        <div class="w-8 h-8 rounded-lg bg-orange-500/20 flex items-center justify-center">
            <svg class="w-4 h-4 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>
        </div>
        <span class="text-[10px] sm:text-xs font-medium text-cosmic-800 dark:text-white/80 text-center">ライブ追加</span>
    </a>
    <a href="{% url 'songdiary:project_create' %}" class="flex flex-col items-center gap-1.5 p-3 rounded-xl bg-green-500/10 dark:bg-green-500/10 border border-green-400/20 hover:bg-green-500/20 transition-all duration-200">
        <div class="w-8 h-8 rounded-lg bg-green-500/20 flex items-center justify-center">
            <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>
        </div>
        <span class="text-[10px] sm:text-xs font-medium text-cosmic-800 dark:text-white/80 text-center">作曲開始</span>
    </a>
</div>

<!-- Practice Week Chart -->
<div class="bg-white/80 dark:bg-white/5 backdrop-blur-md rounded-2xl p-5 border border-cosmic-200/30 dark:border-white/10 mb-6">
    <div class="flex justify-between items-center mb-4">
        <h3 class="font-display font-bold text-cosmic-800 dark:text-white/90">今週の練習</h3>
        <span class="text-xs font-mono text-cosmic-600/60 dark:text-white/40">累計 {{ total_minutes|default:0 }}分</span>
    </div>
    <div class="flex items-end justify-between gap-1.5 h-20">
        {% for day in practice_week %}
        <div class="flex-1 flex flex-col items-center gap-1">
            <div class="w-full rounded-t-md transition-all duration-500 relative group
                        {% if day.minutes > 0 %}bg-gradient-to-t from-cosmic-500 to-nebula-400{% else %}bg-white/10 dark:bg-white/5{% endif %}"
                 style="height: {% if day.pct > 0 %}{{ day.pct }}%{% else %}4px{% endif %}; min-height: 4px;">
                {% if day.minutes > 0 %}
                <div class="absolute -top-6 left-1/2 -translate-x-1/2 text-[10px] font-mono text-cosmic-600 dark:text-white/50 opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">{{ day.minutes }}分</div>
                {% endif %}
            </div>
            <span class="text-[10px] text-cosmic-600/50 dark:text-white/30">{{ day.label }}</span>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Achievements Summary -->
{% if recent_achievements %}
<div class="mb-6">
    <div class="flex justify-between items-center mb-2">
        <h3 class="font-display font-bold text-sm text-cosmic-800 dark:text-white/90">獲得した実績</h3>
        <a href="{% url 'dashboard:achievement_list' %}" class="text-xs text-cosmic-500 dark:text-cosmic-300 hover:text-cosmic-400 transition-colors">すべて見る &rarr;</a>
    </div>
    <div class="flex flex-wrap gap-2">
        {% for ua in recent_achievements %}
        <div class="group flex items-center gap-1.5 px-2.5 py-1.5 bg-white/80 dark:bg-white/5 backdrop-blur-md rounded-lg border border-stardust/20 hover:border-stardust/40 transition-all duration-200"
             title="{{ ua.achievement.description }}">
            <div class="w-5 h-5 rounded bg-gradient-to-br from-stardust/20 to-cosmic-500/20 flex items-center justify-center text-stardust">
                {% include "dashboard/_badge_icons.html" with icon=ua.achievement.icon_name size="w-3 h-3" %}
            </div>
            <span class="text-xs font-display font-bold text-white/70">{{ ua.achievement.name }}</span>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Tabbed Section -->
<div x-data="{ tab: 'heatmap' }" class="mb-6">
    <div class="flex gap-1 mb-4 bg-white/40 dark:bg-white/5 rounded-xl p-1 border border-cosmic-200/20 dark:border-white/5">
        <button @click="tab = 'heatmap'"
                :class="tab === 'heatmap' ? 'bg-white/80 dark:bg-white/10 text-cosmic-800 dark:text-white shadow-sm' : 'text-cosmic-600/60 dark:text-white/40 hover:text-cosmic-600 dark:hover:text-white/60'"
                class="flex-1 px-3 py-2 rounded-lg text-xs font-display font-bold transition-all duration-200">アクティビティ</button>
        <button @click="tab = 'advice'"
                :class="tab === 'advice' ? 'bg-white/80 dark:bg-white/10 text-cosmic-800 dark:text-white shadow-sm' : 'text-cosmic-600/60 dark:text-white/40 hover:text-cosmic-600 dark:hover:text-white/60'"
                class="flex-1 px-3 py-2 rounded-lg text-xs font-display font-bold transition-all duration-200">AIアドバイス</button>
        <button @click="tab = 'feed'"
                :class="tab === 'feed' ? 'bg-white/80 dark:bg-white/10 text-cosmic-800 dark:text-white shadow-sm' : 'text-cosmic-600/60 dark:text-white/40 hover:text-cosmic-600 dark:hover:text-white/60'"
                class="flex-1 px-3 py-2 rounded-lg text-xs font-display font-bold transition-all duration-200">最近の活動</button>
    </div>

    <!-- Tab: Activity Heatmap -->
    <div x-show="tab === 'heatmap'" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100">
        <div class="bg-white/80 dark:bg-white/5 backdrop-blur-md rounded-2xl p-5 border border-cosmic-200/30 dark:border-white/10"
             x-data="calendarHeatmap()" x-init="loadData()">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 mb-4">
                <h3 class="font-display font-bold text-cosmic-800 dark:text-white/90">アクティビティ</h3>
                <div class="flex items-center gap-3">
                    <span class="text-xs font-mono text-cosmic-600/60 dark:text-white/40" x-text="activeCount + '日アクティブ'"></span>
                    <div class="flex items-center gap-1 text-[10px] text-cosmic-600/50 dark:text-white/30">
                        <span>少</span>
                        <span class="inline-block w-2.5 h-2.5 rounded-sm bg-white/5 dark:bg-white/5"></span>
                        <span class="inline-block w-2.5 h-2.5 rounded-sm bg-cosmic-500/30"></span>
                        <span class="inline-block w-2.5 h-2.5 rounded-sm bg-cosmic-500/50"></span>
                        <span class="inline-block w-2.5 h-2.5 rounded-sm bg-cosmic-500/70"></span>
                        <span class="inline-block w-2.5 h-2.5 rounded-sm bg-cosmic-500"></span>
                        <span>多</span>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto pb-1">
                <div class="min-w-[680px]">
                    <div class="flex mb-1 ml-8" style="gap: 2px;">
                        <template x-for="m in monthLabels" :key="m.col">
                            <span class="text-[9px] text-cosmic-600/40 dark:text-white/25 absolute"
                                  :style="'left: ' + (m.col * 12.5 + 32) + 'px'" x-text="m.label"></span>
                        </template>
                    </div>
                    <div class="relative" style="padding-top: 14px;">
                        <div class="absolute left-0 top-[14px] flex flex-col" style="gap: 2px;">
                            <span class="h-[10px] text-[9px] leading-[10px] text-cosmic-600/40 dark:text-white/25 w-7"></span>
                            <span class="h-[10px] text-[9px] leading-[10px] text-cosmic-600/40 dark:text-white/25 w-7">Mon</span>
                            <span class="h-[10px] text-[9px] leading-[10px] text-cosmic-600/40 dark:text-white/25 w-7"></span>
                            <span class="h-[10px] text-[9px] leading-[10px] text-cosmic-600/40 dark:text-white/25 w-7">Wed</span>
                            <span class="h-[10px] text-[9px] leading-[10px] text-cosmic-600/40 dark:text-white/25 w-7"></span>
                            <span class="h-[10px] text-[9px] leading-[10px] text-cosmic-600/40 dark:text-white/25 w-7">Fri</span>
                            <span class="h-[10px] text-[9px] leading-[10px] text-cosmic-600/40 dark:text-white/25 w-7"></span>
                        </div>
                        <div class="ml-8 grid grid-flow-col" style="grid-template-rows: repeat(7, 10px); gap: 2px;">
                            <template x-for="(day, idx) in cells" :key="idx">
                                <div class="w-[10px] h-[10px] rounded-sm cursor-pointer transition-all duration-150 hover:ring-1 hover:ring-white/30"
                                     :class="levelClass(day.level)"
                                     :title="day.date + ': ' + day.tip"
                                     @click="selectDay(day.date)"
                                     :style="day.empty ? 'visibility:hidden' : ''">
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
            <div id="calendar-day-detail" class="mt-3" x-show="selectedDay" x-cloak></div>
        </div>
    </div>

    <!-- Tab: AI Advice -->
    <div x-show="tab === 'advice'" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100">
        <div class="bg-white/80 dark:bg-white/5 backdrop-blur-md rounded-2xl p-5 border border-cosmic-200/30 dark:border-white/10">
            <div class="flex items-center gap-2 mb-3">
                <div class="w-7 h-7 rounded-lg bg-gradient-to-br from-cosmic-500/20 to-nebula-500/20 flex items-center justify-center">
                    <svg class="w-4 h-4 text-cosmic-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.455 2.456L21.75 6l-1.036.259a3.375 3.375 0 0 0-2.455 2.456Z"/>
                    </svg>
                </div>
                <h3 class="font-display font-bold text-cosmic-800 dark:text-white/90">AIアドバイス</h3>
            </div>
            <div id="advice-widget"
                 hx-get="{% url 'dashboard:practice_advice' %}"
                 hx-trigger="load"
                 hx-swap="innerHTML">
                <div class="flex justify-center py-4">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab: Recent Activity -->
    <div x-show="tab === 'feed'" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100">
        {% if activities %}
        <div class="bg-white/80 dark:bg-white/5 backdrop-blur-md rounded-2xl border border-cosmic-200/30 dark:border-white/10 divide-y divide-cosmic-200/20 dark:divide-white/5">
            {% for activity in activities %}
            <a href="{{ activity.url }}" class="flex items-center gap-3 px-5 py-3 hover:bg-white/50 dark:hover:bg-white/5 transition-colors first:rounded-t-2xl last:rounded-b-2xl">
                <div class="w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0
                            {% if activity.type == 'practice' %}bg-nebula-500/15
                            {% elif activity.type == 'live' %}bg-orange-500/15
                            {% elif activity.type == 'project' %}bg-green-500/15
                            {% else %}bg-cosmic-500/15{% endif %}">
                    {% if activity.type == 'practice' %}
                    <svg class="w-4 h-4 text-nebula-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    {% elif activity.type == 'live' %}
                    <svg class="w-4 h-4 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path d="M15 2H9a2 2 0 0 0-2 2v6a5 5 0 0 0 10 0V4a2 2 0 0 0-2-2Z"/><path d="M12 15v4"/><path d="M8 19h8"/></svg>
                    {% elif activity.type == 'project' %}
                    <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    {% else %}
                    <svg class="w-4 h-4 text-cosmic-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.25 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0 1 11.186 0Z"/></svg>
                    {% endif %}
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm text-cosmic-800 dark:text-white/80 truncate">{{ activity.text }}</p>
                </div>
                <time class="text-xs text-cosmic-600/50 dark:text-white/30 flex-shrink-0">{{ activity.date|timesince }}前</time>
            </a>
            {% endfor %}
        </div>
        {% else %}
        <div class="bg-white/80 dark:bg-white/5 backdrop-blur-md rounded-2xl p-8 border border-cosmic-200/30 dark:border-white/10 text-center text-cosmic-600/50 dark:text-white/40">
            まだアクティビティがありません
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<script>
function calendarHeatmap() {
    return {
        cells: [],
        activeCount: 0,
        monthLabels: [],
        selectedDay: null,

        async loadData() {
            try {
                const resp = await fetch('{% url "dashboard:calendar_data" %}');
                const data = await resp.json();
                this.activeCount = data.active_count;
                this.buildGrid(data.days, data.start);
            } catch(e) {
                console.error('Calendar load error:', e);
            }
        },

        buildGrid(days, startStr) {
            const start = new Date(startStr + 'T00:00:00');
            const startDow = start.getDay() === 0 ? 6 : start.getDay() - 1;
            const cells = [];
            for (let i = 0; i < startDow; i++) {
                cells.push({ empty: true, level: 0, date: '', tip: '' });
            }
            const months = [];
            let lastMonth = -1;
            days.forEach((d, idx) => {
                const dt = new Date(d.date + 'T00:00:00');
                const m = dt.getMonth();
                if (m !== lastMonth) {
                    const col = Math.floor((idx + startDow) / 7);
                    const labels = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                    months.push({ col, label: labels[m] });
                    lastMonth = m;
                }
                let tip = '';
                const parts = [];
                if (d.practice > 0) parts.push(d.practice + '分練習');
                if (d.live > 0) parts.push('ライブ' + d.live + '件');
                if (d.compose > 0) parts.push('作曲' + d.compose + '件');
                tip = parts.length ? parts.join(', ') : 'アクティビティなし';
                cells.push({ empty: false, level: d.level, date: d.date, tip: tip });
            });
            this.cells = cells;
            this.monthLabels = months;
        },

        levelClass(level) {
            const classes = [
                'bg-white/[0.03] dark:bg-white/[0.03]',
                'bg-cosmic-500/30',
                'bg-cosmic-500/50',
                'bg-cosmic-500/70',
                'bg-cosmic-500 shadow-[0_0_4px_rgba(199,48,88,0.3)]',
            ];
            return classes[level] || classes[0];
        },

        selectDay(dateStr) {
            if (!dateStr) return;
            this.selectedDay = dateStr;
            htmx.ajax('GET', '/calendar/day/' + dateStr + '/', {
                target: '#calendar-day-detail',
                swap: 'innerHTML',
            });
        },
    };
}
</script>
{% endblock %}
