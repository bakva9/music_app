{% extends "base.html" %}

{% block title %}練習タイマー - 残音{% endblock %}

{% block content %}
<div class="max-w-lg mx-auto" x-data="practiceTimer()">
    <h1 class="font-display text-2xl font-bold text-cosmic-800 dark:text-white text-glow mb-6 text-center">練習タイマー</h1>

    <!-- Timer Display -->
    <div class="bg-white/80 dark:bg-white/5 backdrop-blur-md rounded-2xl p-8 border border-cosmic-200/30 dark:border-white/10 text-center mb-6">
        <div class="w-16 h-16 mx-auto mb-4 animate-float">{% include "partials/baku/_baku_playing.html" %}</div>
        <div class="text-6xl font-mono font-bold text-cosmic-500 dark:text-cosmic-300 text-glow mb-6" x-text="formatTime()"></div>
        <div class="flex justify-center gap-3">
            <button @click="start()" x-show="!running && !paused"
                    class="bg-gradient-to-r from-cosmic-500 to-nebula-500 hover:from-cosmic-400 hover:to-nebula-400 text-white px-8 py-3 rounded-xl font-display font-bold shadow-glow hover:shadow-glow-lg transition-all duration-300 text-lg">開始</button>
            <button @click="pause()" x-show="running"
                    class="bg-gradient-to-r from-stardust to-yellow-400 text-white px-8 py-3 rounded-xl font-display font-bold shadow-glow hover:shadow-glow-lg transition-all duration-300 text-lg">一時停止</button>
            <button @click="resume()" x-show="paused"
                    class="bg-gradient-to-r from-cosmic-500 to-nebula-500 hover:from-cosmic-400 hover:to-nebula-400 text-white px-8 py-3 rounded-xl font-display font-bold shadow-glow hover:shadow-glow-lg transition-all duration-300 text-lg">再開</button>
            <button @click="stop()" x-show="running || paused"
                    class="bg-gradient-to-r from-comet to-red-400 text-white px-8 py-3 rounded-2xl font-display font-bold transition-all duration-300 text-lg">停止</button>
        </div>
    </div>

    <!-- Save Form (shown after stopping) -->
    <div x-show="stopped && elapsed > 0" x-cloak
         class="bg-white/80 dark:bg-white/5 backdrop-blur-md rounded-2xl p-6 border border-cosmic-200/30 dark:border-white/10">
        <h2 class="font-display text-lg font-bold text-cosmic-800 dark:text-white/90 mb-4">セッションを保存</h2>
        <form hx-post="{% url 'guitarlog:save_session' %}" hx-target="#save-result" hx-swap="innerHTML" class="space-y-4">
            {% csrf_token %}
            <input type="hidden" name="duration_minutes" :value="Math.ceil(elapsed / 60)">
            <div>
                <label class="block text-sm font-medium mb-1">練習時間</label>
                <div class="text-2xl font-mono font-bold text-glow" x-text="Math.ceil(elapsed / 60) + '分'"></div>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">評価</label>
                <div class="flex gap-2">
                    <template x-for="i in [1,2,3,4,5]">
                        <button type="button" @click="rating = i"
                                :class="i <= rating ? 'text-stardust text-2xl' : 'text-gray-300 dark:text-gray-600 text-2xl'"
                                x-text="i <= rating ? '★' : '☆'"></button>
                    </template>
                    <input type="hidden" name="rating" :value="rating">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">メモ</label>
                <textarea name="memo" rows="3"
                          class="w-full rounded-2xl border border-cosmic-200/30 dark:border-white/10 bg-white/60 dark:bg-white/5 backdrop-blur-md px-4 py-2"></textarea>
            </div>
            <button type="submit" class="w-full bg-gradient-to-r from-cosmic-500 to-nebula-500 hover:from-cosmic-400 hover:to-nebula-400 text-white py-2 rounded-xl font-display font-bold shadow-glow hover:shadow-glow-lg transition-all duration-300">保存</button>
        </form>
        <div id="save-result"></div>
    </div>

    <div class="mt-6 text-center">
        <a href="{% url 'guitarlog:home' %}" class="text-cosmic-500 dark:text-cosmic-300 hover:text-cosmic-400 dark:hover:text-cosmic-200 transition-colors">&larr; 練習記録に戻る</a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function practiceTimer() {
    return {
        elapsed: 0,
        running: false,
        paused: false,
        stopped: false,
        rating: 0,
        _interval: null,

        start() {
            this.elapsed = 0;
            this.running = true;
            this.paused = false;
            this.stopped = false;
            this._interval = setInterval(() => { this.elapsed++; }, 1000);
        },

        pause() {
            this.running = false;
            this.paused = true;
            clearInterval(this._interval);
        },

        resume() {
            this.running = true;
            this.paused = false;
            this._interval = setInterval(() => { this.elapsed++; }, 1000);
        },

        stop() {
            this.running = false;
            this.paused = false;
            this.stopped = true;
            clearInterval(this._interval);
        },

        formatTime() {
            const h = Math.floor(this.elapsed / 3600);
            const m = Math.floor((this.elapsed % 3600) / 60);
            const s = this.elapsed % 60;
            return (h > 0 ? h + ':' : '') +
                   String(m).padStart(2, '0') + ':' +
                   String(s).padStart(2, '0');
        }
    };
}
</script>
{% endblock %}
